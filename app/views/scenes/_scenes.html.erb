<% if @toggle == "on" %>
  <table class="table">
<% else %>
  <strong><%= date %></strong><br>
<% end %>
<% if option == "no_scene" %>
  <% stories = if situated.instance_of?(Book)
                situated.stories.where(stand_alone: false, publish: true).includes([{ key_points: [:scripted, { scenes: [:section, :rich_text_summary] }] }]).order(:position)
              else
                [situated]
              end %>

  <% scenes_h = {} %>
  <% stories.each do |story| %>
    <% story.key_points.each do |key_point| %>
      <% output_header = false %>
      <ul>
      <% 1.upto(6).each do |selector| %>
        <% scenes = key_point.scenes.where(selector: selector) %>
        <% next unless scenes.size.zero? %>
        <% next if key_point.selector_value(selector).blank? %>
        <% unless output_header %>
          <%== breadcrumb(situated, story, key_point) %> 
          <% output_header = true %>
        <% end %>
        <li><%= KeyPoint.selector_title(selector) %>: <%= key_point.selector_value(selector) %></li>
      <% end %>
      </ul>
    <% end %>
  <% end %>
  <% elsif @option == "has_inserts" %>
    <% scenes2 = Scene.where.not(insert_scene_id: nil).order(:insert_scene_id) %>
    <% old_insert_scene = 0 %>
        <ul>
    <% scenes2.each do |scene| %>
      <% next unless scene.situated.publish %>
      <% if scene.insert_scene_id != old_insert_scene %>
        <% unless old_insert_scene == 0 %>
          </ul>
        <% end %>
        <% old_insert_scene = scene.insert_scene_id %>
        <ul>
      <% end %>
      <li>
        <%= render partial: 'scenes/scene_title', formats: [:html], locals: { scene: scene, scripted: scene.key_point.scripted, key_point: scene.key_point, pdf: nil, target: :_blank } %>
      </li>
    <% end %>
    </ul>
  <% elsif option == "low_word_count" or option == "mid_word_count" or option == "better_word_count" %>
    <% high = 0; low = 0 %>
    <% if @option == "low_word_count" %>
      <% high = 250; low = 0 %>
    <% elsif @option == "mid_word_count" %>
      <% high = 650; low = 250 %>
    <% else %>
      <% high = 1000; low = 650 %>
    <% end %>
    <% stories = if situated.instance_of?(Book)
                situated.stories.where(stand_alone: false, publish: true).includes([{ key_points: [:scripted, { scenes: [:section, :rich_text_summary] }] }]).order(:position)
              else
                [situated]
              end %>
    <% scenes = Scene.get_scenes(situated, 'off') %>
    <% inserted_scenes = [] %>
    <% scenes.keys.sort.each do |year| %>
      <% scenes[year].keys.sort.each do |month| %>
        <% scenes[year][month].keys.sort.each do |day| %>
          <% scenes[year][month][day].keys.sort.each do |hour| %>
            <% scenes[year][month][day][hour].keys.sort.each do |minute| %>
              <% scenes[year][month][day][hour][minute].each do |scene| %>
                <% next if inserted_scenes.include?(scene.id) %>
                <% insert_scenes = Scene.where(insert_scene_id: scene.id) %>
                <% insert_scenes.each do |iscene| %>
                  <% next if inserted_scenes.include?(iscene.id) %>
                  <% next unless iscene.key_point.scripted.publish? %>
                  <% inserted_scenes << iscene %>
                <% end %>
                <% if scene.insert_scene_id.nil? %>
                  <% inserted_scenes << scene %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    <% end -%>

  <%# stories.each do |story| %>
    <%# story.key_points.each do |key_point| %>
    <ul>
      <%# key_point.scenes.each do |scene| %>
      <% inserted_scenes.each do |scene| %>
        <% next unless scene.section.nil? or (scene.section.word_count <= high and scene.section.word_count > low) %>
        <% next unless scene.situated.nil? or scene.situated.publish? %>
        <% next unless scene.key_point.scripted.book_id == @book.id %>
        <li>
          <%= render partial: 'scenes/scene_title', formats: [:html], locals: { scene: scene, scripted: scene.key_point.scripted, key_point: scene.key_point, pdf: nil, target: :_blank } %>
        </li>
      <% end %>
    </ul>
    <%# end %>
<%# end %>
<% else %>
   <%= render partial: 'shared/scenes', locals: { scenes: scenes, op: 'scenes', option: option, toggle: @toggle } %>
<% end %>
<% if @toggle == "on" %>
  </table>
<% else %>
  </ul>
<% end %>
