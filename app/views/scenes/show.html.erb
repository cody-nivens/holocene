<% @title = @scene.section.nil? ? @scene.name : @scene.section.name %>

<h2>
  <%== breadcrumb(@scene.key_point.scripted.book, @scene.key_point.scripted, @scene.key_point, @scene, @scene.section) %>
  <%= link_to (fa_icon 'edit'), edit_scene_path(@scene), title: 'Edit' %>
</h2>

<%= render partial: 'scenes/stats', locals: { object: @scene } %>
<%= tabs do |c| %>
  <% c.tab "Body" do %>
  <% unless @scene.section.nil? %>
    <% values = @scene.set_values %>
    <% text = @scene.section.body %>
    <%== highlight(text.to_s, Regexp.new(KeyWord.where(book_id: values[0].id).collect(&:key_word).join('|'))) %>
  <% end %>
<% end %>
  <% c.tab "summary" do %>
<p>
  <%= @scene.summary %>
</p>
<% end %>
  <% c.tab "Plot" do %>
<% unless @scene.goal_reaction.blank? %>
  <p>
    <strong>Goal/Reaction:</strong>
    <%= @scene.goal_reaction %>
  </p>
<% end %>

<% unless @scene.conflict_dilemma.blank? %>
  <p>
    <strong>Conflict/Dilemma:</strong>
    <%= @scene.conflict_dilemma %>
  </p>
<% end %>

<% unless @scene.disaster_decision.blank? %>
  <p>
    <strong>Disaster/Decision:</strong>
    <%= @scene.disaster_decision %>
  </p>
<% end %>

<% unless @scene.short_term_goal.blank? %>
  <p>
    <strong>Short term goal:</strong>
    <%= @scene.short_term_goal %>
  </p>
<% end %>

<% unless @scene.long_term_goal.blank? %>
  <p>
    <strong>Long term goal:</strong>
    <%= @scene.long_term_goal %>
  </p>
<% end %>

<% unless @scene.over_arching_goal.blank? %>
  <p>
    <strong>Over arching goal:</strong>
    <%= @scene.over_arching_goal %>
  </p>
<% end %>

<% unless @scene.insert_scene.present? %>
  <p>
    <strong>Insert Scene:</strong>
    <%= (@scene.insert_scene.nil? ? '' : @scene.insert_scene.full_name) %>
  </p>
<% end %>

<% unless @scene.characters.size == 0 %>
  <p>
    <strong>Characters:</strong>
    <br>
    <%= render partial: 'characters/characters_occ_ul', formats: [:html], locals: { object: @scene } %>
  </p>
<% end %>

<% end %>
  <% c.tab "Scenes" do %>
<% scenes = Scene.where(insert_scene_id: @scene.id).order(:date_string, :abc) %>
  <% unless scenes.size == 0 %>
    <strong>Scenes:</strong>
    <br>
    <ul>
      <% scenes.includes([:section, :rich_text_summary]).each do |iscene| %>
        <% next unless iscene.key_point.scripted.publish? %>
        <li><%= link_to(iscene.abc, scene_path(iscene)) %> <%= (iscene.section.nil? ? '' : '*') %><%= iscene.time_to_text %> : <%= iscene.name %></li>
        <% insert_scene = iscene %>
      <% end %>
    </ul>
  <% end %>
<% end %>
<% end %>
</p>

<% if @scene.section.nil? %>
  <% add_to_footer('New Section', new_polymorphic_path([@scene, :section])) %>
<% else %>
  <% add_to_footer('Edit Section', edit_section_path(@scene.section)) %>
<% end %>
<% add_to_footer('Characters', polymorphic_path([@scene, :characters])) %>
<% add_to_footer('Move', polymorphic_path([@scene, :move])) %>
<% add_to_footer('Destroy', scene_path(@scene), method: :delete, data: { confirm: 'Are you sure?' }) %>
<% add_to_footer('Back', (@scene.key_point.nil? ? polymorphic_path([@situated, :scenes]) : key_point_path(@scene.key_point))) %>

<% scene_index = @scenes_wi.find_index(@scene.id) %>
<%# prev_scene = @scene %>
<%# loop do prev_scene = prev_scene.previous(field: :date_string) %>
<%# break if prev_scene.nil? or prev_scene.book_id == @scene.book_id %>
<%# end %>
<% unless scene_index.nil? or scene_index == 0 %>
  <% add_to_footer('<', scene_path(id: @scenes_wi[scene_index - 1]), classes: 'btn icon-ok icon-white') %>
<% end %>

<%# next_scene = @scene %>
<%# loop do next_scene = next_scene.next(field: :date_string) %>
<%# break if next_scene.nil? or next_scene.book_id == @scene.book_id %>
<%# end %>
<% unless scene_index.nil? or scene_index == @scenes_wi.length - 1 %>
  <% add_to_footer('>', scene_path(id: @scenes_wi[scene_index + 1]), classes: 'btn icon-ok icon-white') %>
<% end %>
