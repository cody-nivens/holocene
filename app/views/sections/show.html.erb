<% @title = @section.name %>

<turbo-frame id="<%= @section %>">
<h3>
  <% if @section.sectioned.class.name == 'Chapter' %>
    <%== breadcrumb(@section.sectioned.scripted, @section.sectioned, nil, nil, @section) %>
  <% else %>
    <%== breadcrumb(@section.sectioned.key_point.scripted.book, @section.sectioned.key_point.scripted, @section.sectioned.key_point, @section.sectioned, @section) %>
  <% end %>
  <%= link_to (fa_icon 'edit'), edit_polymorphic_path([@sectioned, @section]), title: 'Edit' %>
</h3>
<table class="table">
  <tr>
    <th>Word Count:</th><td><%= number_with_delimiter(@section.word_count, delimiter: ',') %></td>
  </tr>
</table>

<% @slugs = [] -%>
<% @footnotes = Footnote.process_body(@section, @slugs) -%>
<% values = @section.set_values %>
<%== highlight(@footnotes[0], Regexp.new(KeyWord.where(book_id: values[0].id).collect(&:key_word).join('|'))) %>
<% @slugs += @footnotes[1] -%>

<% unless @section.holocene_events.size == 0 || @section.sectioned.show_events? -%>
  <% @section.holocene_events.order(:start_year).each do |he| -%>
    <% unless he.body.blank? -%>
      <% @footnotes = Footnote.process_body(he, slugs, (@footnotes.nil? ? 1 : @footnotes[2])) -%>
      <% @slugs += @footnotes[1] -%>
    <% end -%>
  <% end -%>
  <%= render 'holocene_events/index', formats: [:html], holocene_events: @section.holocene_events.order(:start_year), noted: @noted %>
<% end -%>

<% unless @slugs.size == 0 -%>
  <%== Footnote.write_footnotes(@slugs) %>
<% end -%>

<% priv_section = Section.where(sectioned_id: @sectioned.id, sectioned_type: @sectioned.class.name, position: @section.position - 1) -%>
<% next_section = Section.where(sectioned_id: @sectioned.id, sectioned_type: @sectioned.class.name, position: @section.position + 1) -%>
</turbo-frame>

<div id="side_controls" class="hide-print">
<%= link_to (fa_icon 'edit', class: 'fa-fw'), edit_section_path(@section), class: 'btn', title: 'Edit' %>
<% unless priv_section.size.zero? %>
<%= link_to (fa_icon 'arrow-left', class: 'fa-fw'), section_path(priv_section.first), class: 'btn', title: 'Previous section' %>
<% end %>
<% unless next_section.size.zero? %>
<%= link_to (fa_icon 'arrow-right', class: 'fa-fw'), section_path(next_section.first), class: 'btn' , title: 'Next section' %>
<% end %>
<% if @section.sectioned_type == "Chapter" %>
  <%= link_to (fa_icon 'stream', class: 'fa-fw'), section_timeline_path(section_id: @section.id).to_s, class: 'btn', title: 'Timeline' %>
  <%= link_to (fa_icon 'list-alt', class: 'fa-fw'), section_display_path(section_id: @section.id).to_s, class: 'btn', title: 'Display' %>
  <%= link_to (fa_icon 'map', class: 'fa-fw'), geo_map_section_path(@section).to_s, class: 'btn', title: 'Map' %>
  <%= link_to (fa_icon 'list', class: 'fa-fw'), section_footnotes_path(@section), class: 'btn', title: 'Footnotes' %>
<% end -%>
<%= link_to (fa_icon 'backward', class: 'fa-fw'), polymorphic_path(@sectioned), class: 'btn', title: 'Back' %>
</div>
