<% old_date = '' %>
<% inserted_scenes = [] %>
<% last_scene = nil %>
<% pdf ||= nil %>
<% long ||= nil %>
<% total_wc = 0 %>
<% wc_total = scenes.collect{|x| Scene.find(x.id).word_count }.sum %>

<table style="width: 100%">
  <tbody>
    <% scenes.each do |scene| %>
      <%# scene = Scene.find(scene_id) %>
      <% case op %>
      <% when 'words' %>
        <% next if scene.section.nil? and option != 'low_word_count' and low.to_i > 0 %>
        <% next if !scene.section.nil? and (
                   (option == 'mid_word_count' and (scene.section.word_count >= high.to_i or scene.section.word_count < low.to_i)) or
                   (option == 'better_word_count' and scene.section.word_count <= high.to_i) or
                   (option == 'low_word_count' and scene.section.word_count > low.to_i)) %>
        <%= render partial: 'scenes/scene_title', formats: [:html], locals: { scene: scene, scripted: scene.key_point.scripted, key_point: scene.key_point, pdf: pdf, target: :_blank, long: long } %>
      <% when 'chars' %>
        <% next if scene.characters.size > 0 %>
        <%= render partial: 'scenes/scene_title', formats: [:html], locals: { scene: scene, scripted: scene.key_point.scripted, key_point: scene.key_point, pdf: pdf, target: :_blank, long: long } %>
      <% when 'scenes' %>
        <% next if option == "no_section" && !scene.section.nil? %>
        <% next if option == "only_section" && scene.section.nil? %>
        <% next if option == "checked" && !scene.check? %>
        <% next if option == "not_checked" && scene.check? %>

        <% if toggle == "on" %>
          <tr>
            <td class="text-wrap" style="width: 5%">
              <% if print.nil? %>
                <%= link_to scene.abc, scene_path(scene), method: :get %> <%= (scene.section.nil? ? '*' : '') %>
              <% else %>
                <%= scene.abc %> <%= (scene.section.nil? ? '*' : '') %>
              <% end %>
            </td>
            <td><%= scene.section.nil? ? scene.plain_name : scene.section.name %></td>
            <td class="text-nowrap"><%= scene.time_to_text %></td>
            <td style="width: 20%"><%= scene.place %></td>
            <td style="width: 20%">
              <% scene.characters.order(:occupation_class, :last_name, :first_name).each do |character| %>
                <%= character.full_name %><br>
              <% end %>
            </td>
          </tr>
        <% else %>
          <% values = scene.set_values %>
          <tr><td><%= (scene.section.nil? ? '*' : ' ') -%></td>
            <% if print.nil? %>
              <%= render partial: 'scenes/scene_title', formats: [:html], locals: { scene: scene, scripted: scene.key_point.scripted, key_point: scene.key_point, pdf: pdf, target: :_blank, long: long } %>
            <% else %>
              <%= values.compact.collect(&:name).join('|') -%>
            <% end %>
          </tr>
        <% end %>
      <% when 'view' %>
        <% if scene.title_scene and scene.situated.title_page? %>
          <% unless outline %>
            <div style="display:block; clear:both; page-break-after:always;"></div>
          <% end %>
          <h2><%= scene.situated.title %><%= outline ? " - WC: #{number_with_delimiter total_wc}" : "" %></h2>
        <% end %>
        <% if scene.title_scene and scene.situated.print_summary? %>
          <% unless outline %>
            <%= scene.situated.summary_body %>
            <div style="display:block; clear:both; page-break-after:always;"></div>
          <% end %>
        <% end %>
        <% unless outline %>
          <div style="display:block; clear:both; page-break-after:always;"></div>
        <% end %>
        <%= render partial: 'scenes/scene_view', formats: [:html], locals: { scene: scene, outline: outline, pdf: pdf, long: long, total_wc: total_wc, wc_total: wc_total } %>
        <% total_wc += scene.word_count %>
      <% end %>
    <% end %>
  </tbody>
</table>
